{"version":3,"file":"use-circle-progress.js","sources":["uni_modules/tuniaoui-vue3/components/circle-progress/src/composables/use-circle-progress.ts"],"sourcesContent":["import { computed, getCurrentInstance, nextTick, watch } from 'vue'\nimport { useNamespace } from '../../../../hooks'\nimport { generateId, isEmptyVariableInDefault } from '../../../../utils'\n\nimport type { ComponentInternalInstance } from 'vue'\nimport type { CircleProgressProps } from '../circle-progress'\n\nexport const useCircleProgress = (props: CircleProgressProps) => {\n  const instance = getCurrentInstance() as ComponentInternalInstance\n\n  const ns = useNamespace('circle-progress')\n\n  // 圆环的直径\n  const radius = computed<number>(() => {\n    return isEmptyVariableInDefault(props?.radius, 50)\n  })\n  // 圆环的宽度\n  const ringWidth = computed<number>(() => {\n    return isEmptyVariableInDefault(props?.ringWidth, 14)\n  })\n\n  // 圆环的颜色\n  const circleColor = computed<string>(() => {\n    return isEmptyVariableInDefault(props?.inactiveColor, '#e6e6e6')\n  })\n\n  // 圆环激活时的颜色\n  const activeCircleColor = computed<string>(() => {\n    return isEmptyVariableInDefault(props?.activeColor, '#01beff')\n  })\n\n  // 动画执行时间\n  const duration = computed<number>(() => {\n    return isEmptyVariableInDefault(props?.duration, 1500)\n  })\n\n  // 进度信息，为了产生动画效果，需要在进度条变化时，将进度信息保存下来\n  let currentPercent = 0\n  let prevPercent = 0\n\n  // 生成canvas圆环id\n  const canvasId = String(generateId())\n\n  // canvas容器对象\n  let progressCanvas: UniApp.CanvasContext | null = null\n\n  // 圆环开始角度\n  const startAngle = -90 * (Math.PI / 180)\n\n  // 绘制progress圆环\n  const drawProgressCircle = (percent: number) => {\n    if (!progressCanvas) {\n      progressCanvas = uni.createCanvasContext(canvasId, instance)\n    }\n    // 清空画布\n    progressCanvas.clearRect(0, 0, radius.value * 2, radius.value * 2)\n\n    // 绘制底部圆环\n    progressCanvas.beginPath()\n    // 设置颜色\\线框\n    progressCanvas.setLineWidth(ringWidth.value)\n    progressCanvas.setStrokeStyle(circleColor.value)\n    // 绘制圆环\n    progressCanvas.arc(\n      radius.value,\n      radius.value,\n      radius.value - ringWidth.value / 2,\n      startAngle,\n      Math.PI * 1.5,\n      false\n    )\n    progressCanvas.stroke()\n\n    // 如果进度为0，不绘制进度圆环\n    if (percent === 0) {\n      progressCanvas.draw()\n      return\n    }\n    // 绘制进度圆环\n    progressCanvas.beginPath()\n    // 设置颜色\\线框\n    progressCanvas.setLineCap('round')\n    progressCanvas.setLineWidth(ringWidth.value)\n    progressCanvas.setStrokeStyle(activeCircleColor.value)\n\n    // 结束角度\n    const endAngle = (Math.PI * 2 * percent) / 100 - Math.PI / 2\n    progressCanvas.arc(\n      radius.value,\n      radius.value,\n      radius.value - ringWidth.value / 2,\n      startAngle,\n      endAngle,\n      false\n    )\n    progressCanvas.stroke()\n\n    progressCanvas.draw()\n  }\n\n  // 计算缓动动画时间函数\n  function easeOutCubic(t: number, b: number, c: number, d: number) {\n    return c * ((t = t / d - 1) * t * t + 1) + b\n  }\n\n  // 开始执行动画\n  let startTime: number | null = null\n  const progressAnimation = () => {\n    if (!startTime) startTime = Date.now()\n    const elapsed = Date.now() - startTime\n    let percent = easeOutCubic(\n      elapsed,\n      prevPercent,\n      currentPercent - prevPercent,\n      duration.value\n    )\n    if (percent < 0) percent = 0\n    drawProgressCircle(percent)\n    if (elapsed < duration.value) {\n      setTimeout(progressAnimation, 16)\n    }\n  }\n\n  watch(\n    () => props.percent,\n    (nVal: number, oVal: number | undefined) => {\n      currentPercent = nVal > 100 ? 100 : nVal\n      prevPercent = !oVal || oVal < 0 ? 0 : oVal\n\n      nextTick(() => {\n        startTime = null\n        progressAnimation()\n      })\n    },\n    {\n      immediate: true,\n    }\n  )\n\n  return {\n    ns,\n    canvasId,\n    radius,\n    activeCircleColor,\n  }\n}\n"],"names":["getCurrentInstance","useNamespace","computed","isEmptyVariableInDefault","generateId","uni","watch","nextTick"],"mappings":"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"}