{"version":3,"file":"use-circle-progress.js","sources":["uni_modules/tuniaoui-vue3/components/circle-progress/src/composables/use-circle-progress.ts"],"sourcesContent":["import { computed, getCurrentInstance, nextTick, watch } from 'vue'\r\nimport { useNamespace } from '../../../../hooks'\r\nimport { generateId, isEmptyVariableInDefault } from '../../../../utils'\r\n\r\nimport type { ComponentInternalInstance } from 'vue'\r\nimport type { CircleProgressProps } from '../circle-progress'\r\n\r\nexport const useCircleProgress = (props: CircleProgressProps) => {\r\n  const instance = getCurrentInstance() as ComponentInternalInstance\r\n\r\n  const ns = useNamespace('circle-progress')\r\n\r\n  // 圆环的直径\r\n  const radius = computed<number>(() => {\r\n    return isEmptyVariableInDefault(props?.radius, 50)\r\n  })\r\n  // 圆环的宽度\r\n  const ringWidth = computed<number>(() => {\r\n    return isEmptyVariableInDefault(props?.ringWidth, 14)\r\n  })\r\n\r\n  // 圆环的颜色\r\n  const circleColor = computed<string>(() => {\r\n    return isEmptyVariableInDefault(props?.inactiveColor, '#e6e6e6')\r\n  })\r\n\r\n  // 圆环激活时的颜色\r\n  const activeCircleColor = computed<string>(() => {\r\n    return isEmptyVariableInDefault(props?.activeColor, '#01beff')\r\n  })\r\n\r\n  // 动画执行时间\r\n  const duration = computed<number>(() => {\r\n    return isEmptyVariableInDefault(props?.duration, 1500)\r\n  })\r\n\r\n  // 进度信息，为了产生动画效果，需要在进度条变化时，将进度信息保存下来\r\n  let currentPercent = 0\r\n  let prevPercent = 0\r\n\r\n  // 生成canvas圆环id\r\n  const canvasId = String(generateId())\r\n\r\n  // canvas容器对象\r\n  let progressCanvas: UniApp.CanvasContext | null = null\r\n\r\n  // 圆环开始角度\r\n  const startAngle = -90 * (Math.PI / 180)\r\n\r\n  // 绘制progress圆环\r\n  const drawProgressCircle = (percent: number) => {\r\n    if (!progressCanvas) {\r\n      progressCanvas = uni.createCanvasContext(canvasId, instance)\r\n    }\r\n    // 清空画布\r\n    progressCanvas.clearRect(0, 0, radius.value * 2, radius.value * 2)\r\n\r\n    // 绘制底部圆环\r\n    progressCanvas.beginPath()\r\n    // 设置颜色\\线框\r\n    progressCanvas.setLineWidth(ringWidth.value)\r\n    progressCanvas.setStrokeStyle(circleColor.value)\r\n    // 绘制圆环\r\n    progressCanvas.arc(\r\n      radius.value,\r\n      radius.value,\r\n      radius.value - ringWidth.value / 2,\r\n      startAngle,\r\n      Math.PI * 1.5,\r\n      false\r\n    )\r\n    progressCanvas.stroke()\r\n\r\n    // 如果进度为0，不绘制进度圆环\r\n    if (percent === 0) {\r\n      progressCanvas.draw()\r\n      return\r\n    }\r\n    // 绘制进度圆环\r\n    progressCanvas.beginPath()\r\n    // 设置颜色\\线框\r\n    progressCanvas.setLineCap('round')\r\n    progressCanvas.setLineWidth(ringWidth.value)\r\n    progressCanvas.setStrokeStyle(activeCircleColor.value)\r\n\r\n    // 结束角度\r\n    const endAngle = (Math.PI * 2 * percent) / 100 - Math.PI / 2\r\n    progressCanvas.arc(\r\n      radius.value,\r\n      radius.value,\r\n      radius.value - ringWidth.value / 2,\r\n      startAngle,\r\n      endAngle,\r\n      false\r\n    )\r\n    progressCanvas.stroke()\r\n\r\n    progressCanvas.draw()\r\n  }\r\n\r\n  // 计算缓动动画时间函数\r\n  function easeOutCubic(t: number, b: number, c: number, d: number) {\r\n    return c * ((t = t / d - 1) * t * t + 1) + b\r\n  }\r\n\r\n  // 开始执行动画\r\n  let startTime: number | null = null\r\n  const progressAnimation = () => {\r\n    if (!startTime) startTime = Date.now()\r\n    const elapsed = Date.now() - startTime\r\n    let percent = easeOutCubic(\r\n      elapsed,\r\n      prevPercent,\r\n      currentPercent - prevPercent,\r\n      duration.value\r\n    )\r\n    if (percent < 0) percent = 0\r\n    drawProgressCircle(percent)\r\n    if (elapsed < duration.value) {\r\n      setTimeout(progressAnimation, 16)\r\n    }\r\n  }\r\n\r\n  watch(\r\n    () => props.percent,\r\n    (nVal: number, oVal: number | undefined) => {\r\n      currentPercent = nVal > 100 ? 100 : nVal\r\n      prevPercent = !oVal || oVal < 0 ? 0 : oVal\r\n\r\n      nextTick(() => {\r\n        startTime = null\r\n        progressAnimation()\r\n      })\r\n    },\r\n    {\r\n      immediate: true,\r\n    }\r\n  )\r\n\r\n  return {\r\n    ns,\r\n    canvasId,\r\n    radius,\r\n    activeCircleColor,\r\n  }\r\n}\r\n"],"names":["getCurrentInstance","useNamespace","computed","isEmptyVariableInDefault","generateId","uni","watch","nextTick"],"mappings":"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"}