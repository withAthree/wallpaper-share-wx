{"version":3,"file":"use-form-item-operation.js","sources":["uni_modules/tuniaoui-vue3/components/form/src/composables/use-form-item-operation.ts"],"sourcesContent":["import { computed, inject, nextTick, ref, watch } from 'vue'\r\nimport AsyncValidator from '../../../../libs/async-validator'\r\nimport { castArray, debounce } from '../../../../libs/lodash'\r\nimport { formContextKey } from '../../../../tokens'\r\nimport {\r\n  cloneDeep,\r\n  getProp,\r\n  isEmptyVariableInDefault,\r\n  isFunction,\r\n  isString,\r\n} from '../../../../utils'\r\n\r\nimport type { Slots } from 'vue'\r\nimport type { RuleItem } from '../../../../libs/async-validator'\r\nimport type { FormItemProps, FormItemValidateStates } from '../form-item'\r\nimport type {\r\n  FormItemContext,\r\n  FormItemRule,\r\n  FormValidateFailure,\r\n} from '../types'\r\nimport type { Arrayable } from '../../../../utils'\r\n\r\nexport const useFormItemOperation = (props: FormItemProps, slots: Slots) => {\r\n  const formContext = inject(formContextKey, undefined)\r\n\r\n  // 初始化的值\r\n  let initialValue: any = undefined\r\n  // 是否重置字段校验\r\n  let isResettingField = false\r\n\r\n  // 校验状态\r\n  const validateState = ref<FormItemValidateStates>('')\r\n  const validateStateDebounced = ref<FormItemValidateStates>('')\r\n\r\n  // 错误信息\r\n  const validateMessage = ref('')\r\n\r\n  // 是否有标签\r\n  const hasLabel = computed(() => {\r\n    return !!(props.label || slots.label)\r\n  })\r\n\r\n  // 当前标签的值\r\n  const currentLabel = computed(\r\n    () => `${props.label || ''}${formContext?.labelSuffix || ''}`\r\n  )\r\n\r\n  // formItem field字段名称\r\n  const fieldValue = computed(() => {\r\n    const model = formContext?.model\r\n    if (!model || !props.prop) {\r\n      return\r\n    }\r\n    return getProp(model, props.prop).value\r\n  })\r\n\r\n  // formItem prop字段名称\r\n  const propString = computed(() => {\r\n    if (!props.prop) return ''\r\n    return isString(props.prop) ? props.prop : props.prop.join('.')\r\n  })\r\n\r\n  // 校验规则\r\n  const normalizedRules = computed(() => {\r\n    const rules: FormItemRule[] = []\r\n    // 如果设置了rules，则直接使用rules\r\n    if (props.rules) rules.push(...castArray(props.rules))\r\n\r\n    // 如果设置了prop，则根据prop从formContext中获取rules\r\n    const formRules = formContext?.rules\r\n    if (formRules && props.prop) {\r\n      const _rules = getProp<Arrayable<FormItemRule> | undefined>(\r\n        formRules,\r\n        props.prop\r\n      ).value\r\n      if (_rules) rules.push(...castArray(_rules))\r\n    }\r\n\r\n    // 如果设置了required，则根据required的值来设置校验规则\r\n    if (props.required !== undefined) {\r\n      const requiredRules = rules\r\n        .map((rule, index) => [rule, index] as const)\r\n        .filter(([rule]) => Object.keys(rule).includes('required'))\r\n      if (requiredRules.length) {\r\n        for (const [rule, index] of requiredRules) {\r\n          if (rule.required === props.required) continue\r\n          rules[index] = { ...rule, required: props.required }\r\n        }\r\n      } else {\r\n        rules.push({ required: props.required })\r\n      }\r\n    }\r\n\r\n    return rules\r\n  })\r\n\r\n  // 是否需要校验（开启校验）\r\n  const validateEnabled = computed(() => normalizedRules.value.length > 0)\r\n\r\n  // 是否为必填\r\n  const isRequired = computed(() =>\r\n    normalizedRules.value.some((rule) => rule.required)\r\n  )\r\n\r\n  // 是否显示错误信息\r\n  const shouldShowError = computed(\r\n    () =>\r\n      validateStateDebounced.value === 'error' &&\r\n      props.showMessage &&\r\n      isEmptyVariableInDefault(formContext?.showMessage, true)\r\n  )\r\n\r\n  // 设置校验状态\r\n  const setValidateState = (state: FormItemValidateStates) => {\r\n    validateState.value = state\r\n  }\r\n\r\n  // 获取校验规则\r\n  const getFilterRule = (trigger: string) => {\r\n    const rules = normalizedRules.value\r\n    return (\r\n      rules\r\n        .filter((rule) => {\r\n          if (!rule.trigger || !trigger) return true\r\n          if (Array.isArray(rule.trigger)) {\r\n            return rule.trigger.includes(trigger)\r\n          } else {\r\n            return rule.trigger === trigger\r\n          }\r\n        })\r\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n        .map(({ trigger, ...rule }): RuleItem => rule)\r\n    )\r\n  }\r\n\r\n  // 校验失败\r\n  const onValidationFailed = (error: FormValidateFailure) => {\r\n    const { errors, fields } = error\r\n    if (!errors || !fields) {\r\n      console.error(error)\r\n    }\r\n\r\n    setValidateState('error')\r\n    validateMessage.value = errors\r\n      ? isEmptyVariableInDefault(errors?.[0]?.message, `${props.prop} 为必填项`)\r\n      : ''\r\n\r\n    formContext?.emits('validate', props.prop!, false, validateMessage.value)\r\n  }\r\n\r\n  // 校验通过\r\n  const onValidationSucceded = () => {\r\n    setValidateState('success')\r\n    validateMessage.value = ''\r\n\r\n    formContext?.emits('validate', props.prop!, true, '')\r\n  }\r\n\r\n  // 进行校验操作\r\n  const doValidate = async (rules: RuleItem[]): Promise<true> => {\r\n    const modelName = propString.value\r\n    const validator = new AsyncValidator({\r\n      [modelName]: rules,\r\n    })\r\n    return validator\r\n      .validate({ [modelName]: fieldValue.value }, { firstFields: true })\r\n      .then(() => {\r\n        onValidationSucceded()\r\n        return true as const\r\n      })\r\n      .catch((err: FormValidateFailure) => {\r\n        onValidationFailed(err as FormValidateFailure)\r\n        return Promise.reject(err)\r\n      })\r\n  }\r\n\r\n  // 校验\r\n  const validate: FormItemContext['validate'] = async (trigger, callback) => {\r\n    // 重置字段后跳过校验\r\n    if (isResettingField || !props.prop) return false\r\n\r\n    const hasCallback = isFunction(callback)\r\n    if (!validateEnabled.value) {\r\n      callback?.(false)\r\n      return false\r\n    }\r\n\r\n    const rules = getFilterRule(trigger)\r\n    if (rules.length === 0) {\r\n      callback?.(true)\r\n      return true\r\n    }\r\n\r\n    setValidateState('validating')\r\n\r\n    return doValidate(rules)\r\n      .then(() => {\r\n        callback?.(true)\r\n        return true as const\r\n      })\r\n      .catch((err: FormValidateFailure) => {\r\n        const { fields } = err\r\n        callback?.(false, fields)\r\n        return hasCallback ? false : Promise.reject(fields)\r\n      })\r\n  }\r\n\r\n  // 清除校验信息\r\n  const clearValidate: FormItemContext['clearValidate'] = () => {\r\n    setValidateState('')\r\n    validateMessage.value = ''\r\n    isResettingField = false\r\n  }\r\n\r\n  // 重置字段\r\n  const resetField: FormItemContext['resetField'] = async () => {\r\n    const model = formContext?.model\r\n    if (!model || !props.prop) return\r\n\r\n    const computedValue = getProp(model, props.prop)\r\n\r\n    // 阻止触发校验\r\n    isResettingField = true\r\n\r\n    computedValue.value = cloneDeep(initialValue)\r\n\r\n    await nextTick()\r\n    clearValidate()\r\n\r\n    isResettingField = false\r\n  }\r\n\r\n  // 设置初始化的值\r\n  const initFieldValue = () => {\r\n    initialValue = cloneDeep(fieldValue.value)\r\n  }\r\n\r\n  const validateStateDebouncedUpdater = debounce(() => {\r\n    validateStateDebounced.value = validateState.value\r\n  }, 100)\r\n  watch(\r\n    () => validateState.value,\r\n    () => validateStateDebouncedUpdater()\r\n  )\r\n\r\n  watch(\r\n    () => props.error,\r\n    (val) => {\r\n      validateMessage.value = val || ''\r\n      setValidateState(val ? 'error' : '')\r\n    },\r\n    {\r\n      immediate: true,\r\n    }\r\n  )\r\n\r\n  watch(\r\n    () => props.validateStatus,\r\n    (val) => {\r\n      setValidateState(val || '')\r\n    }\r\n  )\r\n\r\n  return {\r\n    formContext,\r\n    hasLabel,\r\n    currentLabel,\r\n    validateState,\r\n    validateMessage,\r\n    isRequired,\r\n    shouldShowError,\r\n    doValidate,\r\n    validate,\r\n    clearValidate,\r\n    resetField,\r\n    initFieldValue,\r\n  }\r\n}\r\n"],"names":["inject","formContextKey","ref","computed","getProp","isString","castArray","rule","index","_a","_b","__read","__values","isEmptyVariableInDefault","__rest","uni","__awaiter","AsyncValidator","isFunction","cloneDeep","nextTick","debounce","watch"],"mappings":"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"}