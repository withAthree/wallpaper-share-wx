{"code":"import { ref, watch } from 'vue';\nimport { isArray, isEmptyVariableInDefault, isPromise, isString, } from '../../../../utils';\nimport { isJsonString } from '../../../../utils/validator';\nexport default function useUploadHandleFunction(props) {\n    // 选择系统图片\n    const chooseImage = (count) => {\n        return new Promise((resolve, reject) => {\n            uni.chooseImage({\n                count,\n                sizeType: props.sizeType,\n                // extension: props.extensions,\n                sourceType: props.sourceType,\n                success: (res) => {\n                    resolve(isArray(res.tempFiles) ? res.tempFiles : [res.tempFiles]);\n                },\n                fail: (err) => {\n                    reject(err);\n                },\n            });\n        });\n    };\n    // 上传图片事件，调用接口\n    // 正在上传标识\n    const uploading = ref(false);\n    watch(() => { return uploading.value; }, (val) => {\n        if (props.showErrorTips) {\n            if (val)\n                uni.showLoading({ title: '上传中' });\n            else\n                uni.hideLoading();\n        }\n    });\n    const uploadProcess = (item) => {\n        const customUploadHandler = props.customUploadHandler, customUploadCallback = props.customUploadCallback;\n        if (uploading.value)\n            return Promise.reject('有文件正在上传');\n        return new Promise((resolve, reject) => {\n            // 如果有自定义上传处理函数，则调用自定义上传处理函数\n            if (customUploadHandler) {\n                const uploadHandlerResult = customUploadHandler(item.file);\n                const isUploadHandlePromiseOrString = [\n                    isPromise(uploadHandlerResult),\n                    isString(uploadHandlerResult),\n                ].includes(true);\n                if (!isUploadHandlePromiseOrString) {\n                    uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:57', '[TnImageUpload]自定义上传处理函数必须返回Promise和String');\n                    reject('自定义上传处理函数必须返回Promise和String');\n                    return;\n                }\n                uploading.value = true;\n                item.status = 'uploading';\n                if (isPromise(uploadHandlerResult)) {\n                    uploadHandlerResult\n                        .then((res) => {\n                        if (res) {\n                            item.url = res;\n                            resolve(true);\n                        }\n                        else {\n                            resolve(false);\n                        }\n                    })\n                        .catch((err) => {\n                        uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:77', '[TnImageUpload]上传文件发生错误', err);\n                        reject((err === null || err === void 0 ? void 0 : err.errMsg) || '上传文件发生错误');\n                    })\n                        .finally(() => {\n                        uploading.value = false;\n                    });\n                }\n                else {\n                    if (uploadHandlerResult) {\n                        item.url = uploadHandlerResult;\n                        resolve(true);\n                    }\n                    else {\n                        resolve(false);\n                    }\n                    uploading.value = false;\n                }\n            }\n            else {\n                // 内部集成图片上传\n                uploading.value = true;\n                item.status = 'uploading';\n                // 创建上传对象\n                const task = uni.uploadFile({\n                    url: props.action,\n                    filePath: item.url,\n                    name: props.name,\n                    formData: props.formData,\n                    header: props.header,\n                    success: (res) => {\n                        // 判断用户是否自己处理上传后服务器回传的结果\n                        if (customUploadCallback) {\n                            const customUploadCallbackResult = customUploadCallback(res);\n                            const isCustomUploadCallbackPromiseOrString = [\n                                isPromise(customUploadCallbackResult),\n                                isString(customUploadCallbackResult),\n                            ].includes(true);\n                            if (!isCustomUploadCallbackPromiseOrString) {\n                                uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:113', '[TnImageUpload]自定义上传回调函数必须返回Promise和String');\n                                reject('自定义上传回调函数必须返回Promise和String');\n                                return;\n                            }\n                            if (isPromise(customUploadCallbackResult)) {\n                                customUploadCallbackResult\n                                    .then((res) => {\n                                    if (res) {\n                                        item.url = res;\n                                        resolve(true);\n                                    }\n                                    else {\n                                        resolve(false);\n                                    }\n                                })\n                                    .catch((err) => {\n                                    uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:131', '[TnImageUpload]上传文件发生错误', err);\n                                    reject((err === null || err === void 0 ? void 0 : err.errMsg) || '上传文件发生错误');\n                                });\n                            }\n                            else {\n                                if (customUploadCallbackResult) {\n                                    item.url = customUploadCallbackResult;\n                                    resolve(true);\n                                }\n                                else {\n                                    resolve(false);\n                                }\n                            }\n                        }\n                        else {\n                            // 使用集成的上传回调函数\n                            const statusCode = res.statusCode, resData = res.data;\n                            if (![200, 201, 204].includes(statusCode)) {\n                                uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:146', '[TnImageUpload]上传文件发生错误', res);\n                                reject((res === null || res === void 0 ? void 0 : res.errMsg) || '上传文件发生错误');\n                                return;\n                            }\n                            else {\n                                const data = isJsonString(resData)\n                                    ? JSON.parse(resData)\n                                    : resData;\n                                // 默认返回的格式为 { code: 200, data: { errorCode: 0,  url: '' } }\n                                if (data.code === 200 && data.data.errCode === 0) {\n                                    item.url = data.data.url;\n                                    resolve(true);\n                                }\n                                else {\n                                    uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:158', '[TnImageUpload]上传文件发生错误', res);\n                                    reject(isEmptyVariableInDefault(data === null || data === void 0 ? void 0 : data.message, (data === null || data === void 0 ? void 0 : data.msg) || '上传文件发生错误'));\n                                }\n                            }\n                        }\n                    },\n                    fail: (err) => {\n                        uni.__f__('error', 'at uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.ts:170', '[TnImageUpload]上传文件发生错误', err);\n                        reject((err === null || err === void 0 ? void 0 : err.errMsg) || '上传文件发生错误');\n                    },\n                    complete: () => {\n                        uploading.value = false;\n                        resolve(true);\n                    },\n                });\n                item.uploadTask = task;\n                // 监听上传进度\n                task.onProgressUpdate((res) => {\n                    if (res.progress > 0) {\n                        item.progress = res.progress;\n                    }\n                });\n            }\n        });\n    };\n    // 检查文件是否超过最大文件尺寸或者不符合上传文件类型\n    const checkFileSizeAndExtension = (files) => {\n        const extensions = props.extensions, maxSize = props.maxSize;\n        const extReg = /.+\\./;\n        return files.filter((item) => {\n            // 获取文件后缀名\n            let fileExt = '';\n            fileExt = item.path\n                .replace(extReg, '')\n                .toLowerCase();\n            return (!extensions.some((ext) => { return ext.toLowerCase() === fileExt; }) ||\n                item.size > maxSize);\n        });\n    };\n    // 是否显示错误提示\n    const showErrorTips = (msg) => {\n        if (!props.showErrorTips)\n            return;\n        uni.showToast({\n            icon: 'none',\n            title: msg,\n        });\n    };\n    return {\n        chooseImage,\n        uploadProcess,\n        checkFileSizeAndExtension,\n        showErrorTips,\n    };\n}\n//# sourceMappingURL=D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-upload-handle-function.js.map","references":["D:/DEV/HBuilderX/plugins/uniapp-cli-vite/node_modules/@vue/runtime-core/dist/runtime-core.d.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/utils/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/utils/validator/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/image-upload/src/types.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/image-upload/src/image-upload.ts"],"uniExtApis":[],"map":"{\"version\":3,\"file\":\"use-upload-handle-function.js\",\"sourceRoot\":\"\",\"sources\":[\"use-upload-handle-function.ts\"],\"names\":[],\"mappings\":\"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\"}"}
