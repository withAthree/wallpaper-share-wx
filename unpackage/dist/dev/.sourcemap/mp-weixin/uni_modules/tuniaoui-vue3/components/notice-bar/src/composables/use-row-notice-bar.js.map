{"version":3,"file":"use-row-notice-bar.js","sources":["uni_modules/tuniaoui-vue3/components/notice-bar/src/composables/use-row-notice-bar.ts"],"sourcesContent":["import {\r\n  computed,\r\n  getCurrentInstance,\r\n  inject,\r\n  nextTick,\r\n  onMounted,\r\n  ref,\r\n  watch,\r\n} from 'vue'\r\nimport { noticeBarKey } from '../../../../tokens'\r\nimport { useSelectorQuery } from '../../../../hooks'\r\nimport {\r\n  debugWarn,\r\n  generateId,\r\n  isEmptyVariableInDefault,\r\n} from '../../../../utils'\r\n\r\nexport const useRowNoticeBar = () => {\r\n  const instance = getCurrentInstance()\r\n  const noticeBar = inject(noticeBarKey, null)\r\n\r\n  const { getSelectorNodeInfo } = useSelectorQuery(instance)\r\n\r\n  const componentId = `trnb-${generateId()}`\r\n  const componentTextId = `${componentId}-text`\r\n\r\n  // 需要显示的数据\r\n  const data = computed<string>(() => {\r\n    if (!noticeBar?.data?.length) return ''\r\n    return noticeBar.data.join(' ')\r\n  })\r\n\r\n  // 每秒显示的像素数\r\n  const speed = computed<number>(() =>\r\n    isEmptyVariableInDefault(noticeBar?.speed, 80)\r\n  )\r\n\r\n  // 动画参数\r\n  let animationDuration = 0\r\n  let animation: UniApp.Animation | null = null\r\n  const animationData = ref<any>(null)\r\n  let animationLoopTimer: ReturnType<typeof setInterval> | null = null\r\n\r\n  // 创建动画\r\n  const createAnimation = () => {\r\n    animation = uni.createAnimation({\r\n      duration: animationDuration,\r\n      timingFunction: 'linear',\r\n    })\r\n\r\n    animation\r\n      .translateX(\r\n        -(contentWidth + contentTextWidth) + Number(Math.random() * 10)\r\n      )\r\n      .step({\r\n        duration: animationDuration,\r\n      })\r\n    animation.translateX(0).step({\r\n      duration: 0,\r\n    })\r\n\r\n    animationData.value = animation.export()\r\n  }\r\n  // 创建循环动画\r\n  const createLoopAnimation = () => {\r\n    createAnimation()\r\n    animationLoopTimer = setInterval(() => {\r\n      createAnimation()\r\n    }, animationDuration + 80)\r\n  }\r\n  // 停止动画\r\n  const stopAnimation = () => {\r\n    animation = null\r\n    animationData.value = null\r\n    if (animationLoopTimer) {\r\n      clearInterval(animationLoopTimer)\r\n      animationLoopTimer = null\r\n    }\r\n  }\r\n\r\n  watch(\r\n    () => noticeBar?.play,\r\n    (newVal) => {\r\n      if (newVal) {\r\n        createLoopAnimation()\r\n      } else {\r\n        stopAnimation()\r\n      }\r\n    }\r\n  )\r\n\r\n  let initCount = 0\r\n  // 获取内容区域容器信息\r\n  let contentWidth = 0\r\n  let contentTextWidth = 0\r\n  const getContentRectInfo = async () => {\r\n    try {\r\n      const contentRectInfo = await getSelectorNodeInfo(`#${componentId}`)\r\n      const contentTextRectInfo = await getSelectorNodeInfo(\r\n        `#${componentTextId}`\r\n      )\r\n\r\n      initCount = 0\r\n\r\n      // 根据 t=s/v(时间=路程/速度)\r\n      contentWidth = contentRectInfo.width || 0\r\n      contentTextWidth = contentTextRectInfo.width || 0\r\n      animationDuration =\r\n        ((contentWidth + contentTextWidth) / speed.value) * 1000\r\n\r\n      if (noticeBar?.play && noticeBar?.autoPlay) {\r\n        setTimeout(() => {\r\n          createLoopAnimation()\r\n        }, 50)\r\n      }\r\n    } catch (err) {\r\n      if (initCount > 10) {\r\n        initCount = 0\r\n        debugWarn('TnNoticeBar', `获取通知栏容器信息失败: ${err}`)\r\n        return\r\n      }\r\n      initCount++\r\n      setTimeout(() => {\r\n        getContentRectInfo()\r\n      }, 150)\r\n    }\r\n  }\r\n\r\n  // 如果修改了speed重新初始化\r\n  watch(\r\n    () => noticeBar?.speed,\r\n    () => {\r\n      stopAnimation()\r\n      getContentRectInfo()\r\n    }\r\n  )\r\n\r\n  // 通知点击事件\r\n  const noticeClickEvent = () => {\r\n    noticeBar?.click(0)\r\n  }\r\n\r\n  onMounted(() => {\r\n    nextTick(() => {\r\n      getContentRectInfo()\r\n    })\r\n  })\r\n\r\n  return {\r\n    componentId,\r\n    componentTextId,\r\n    data,\r\n    animationData,\r\n    noticeClickEvent,\r\n  }\r\n}\r\n"],"names":["getCurrentInstance","inject","noticeBarKey","useSelectorQuery","generateId","computed","isEmptyVariableInDefault","ref","uni","watch","__awaiter","debugWarn","onMounted","nextTick"],"mappings":"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"}