{"version":3,"file":"use-water-fall.js","sources":["uni_modules/tuniaoui-vue3/components/water-fall/src/composables/use-water-fall.ts"],"sourcesContent":["import { getCurrentInstance, nextTick, ref, watch } from 'vue'\nimport { useSelectorQuery } from '../../../../hooks'\nimport { cloneDeep, debugWarn, generateId } from '../../../../utils'\nimport type { WaterFallProps } from '../water-fall'\n\nexport const useWaterFall = (props: WaterFallProps) => {\n  const instance = getCurrentInstance()\n  if (!instance) {\n    debugWarn('TnWaterFall', '请在 setup 中使用 useWaterFall')\n  }\n  const componentId = `twf-${generateId()}`\n\n  const { getSelectorNodeInfo } = useSelectorQuery(instance)\n\n  // 切割左右两边数据\n  const leftData = ref<any[]>([])\n  const rightData = ref<any[]>([])\n\n  // 获取左右两边容器的高度信息\n  let leftContainerHeight = 0\n  let rightContainerHeight = 0\n  const getContainerHeight = async () => {\n    try {\n      const leftContainerRectInfo = await getSelectorNodeInfo(\n        `#${componentId}-left`\n      )\n      const rightContainerRectInfo = await getSelectorNodeInfo(\n        `#${componentId}-right`\n      )\n\n      leftContainerHeight = leftContainerRectInfo.height || leftContainerHeight\n      rightContainerHeight =\n        rightContainerRectInfo.height || rightContainerHeight\n    } catch (err) {\n      debugWarn('TnWaterFall', `获取容器高度信息失败：${err}`)\n    }\n  }\n\n  // 旧数据\n  let oldUserData: any[] = []\n  // 分割数据\n  const splitData = async (data: any[]) => {\n    if (!data || !data.length) return\n    if (props.mode === 'calc') {\n      // 根据左右两边的数据高度，判断当前数据应该放在左边还是右边\n      await getContainerHeight()\n      if (leftContainerHeight <= rightContainerHeight) {\n        leftData.value.push(data.shift())\n      } else {\n        rightData.value.push(data.shift())\n      }\n      nextTick(() => {\n        setTimeout(() => {\n          splitData(data)\n        }, 200)\n      })\n    } else if (props.mode === 'normal') {\n      // 判断当前的第一个元素是放在左边还是右边\n      let firstLeft = true\n      await getContainerHeight()\n      if (leftData.value.length > rightData.value.length) {\n        firstLeft = false\n      }\n      let leftSmall = false\n      if (leftContainerHeight < rightContainerHeight) {\n        leftSmall = true\n      }\n\n      // 按照顺序，左右交替放置数据\n      data.forEach((item, index) => {\n        if ((index % 2 === 0 && firstLeft) || leftSmall) {\n          leftData.value.push(item)\n        } else {\n          rightData.value.push(item)\n        }\n        if (!firstLeft) {\n          firstLeft = true\n        }\n        if (leftSmall && index >= 2) {\n          leftSmall = false\n        }\n      })\n    }\n  }\n\n  // 重新渲染列表\n  const resetWaterFall = () => {\n    if (!props.data) return\n    leftData.value = []\n    rightData.value = []\n    leftContainerHeight = 0\n    rightContainerHeight = 0\n    nextTick(() => {\n      oldUserData = props.data\n      splitData(props.data)\n    })\n  }\n\n  watch(\n    () => props.data,\n    (val) => {\n      if (!val) return\n      if (oldUserData.length === val.length) return\n      const newData = cloneDeep(val.slice(oldUserData.length))\n      if (!newData.length) {\n        leftData.value = []\n        rightData.value = []\n        leftContainerHeight = 0\n        rightContainerHeight = 0\n      }\n      nextTick(() => {\n        oldUserData = val\n        splitData(newData)\n      })\n    },\n    {\n      immediate: true,\n    }\n  )\n\n  return {\n    componentId,\n    leftData,\n    rightData,\n    resetWaterFall,\n  }\n}\n"],"names":["getCurrentInstance","debugWarn","generateId","useSelectorQuery","ref","__awaiter","nextTick","watch","cloneDeep"],"mappings":";;;;;;;;AAKO,MAAM,eAAe,CAAC,UAAqB;AAChD,QAAM,WAAWA,cAAAA;AACjB,MAAI,CAAC,UAAU;AACbC,mDAAU,eAAe,2BAA2B;AAAA,EACrD;AACD,QAAM,cAAc,OAAOC,oCAAU,WAAA,CAAE;AAE/B,QAAA,sBAAwBC,sDAAAA,iBAAiB,QAAQ;AAGzD,QAAM,WAAWC,kBAAW,CAAA,CAAE;AAC9B,QAAM,YAAYA,kBAAW,CAAA,CAAE;AAG/B,MAAI,sBAAsB;AAC1B,MAAI,uBAAuB;AAC3B,QAAM,qBAAqB,MAAA;AAAA,WAAAC,cAAA,UAAA,QAAA,QAAA,QAAA,aAAA;AACzB,UAAI;AACF,cAAM,wBAAwB,MAAM,oBAClC,IAAI,WAAW,OAAO;AAExB,cAAM,yBAAyB,MAAM,oBACnC,IAAI,WAAW,QAAQ;AAGzB,8BAAsB,sBAAsB,UAAU;AACtD,+BACE,uBAAuB,UAAU;AAAA,MACpC,SAAQ,KAAK;AACZJ,6CAAAA,UAAU,eAAe,cAAc,GAAG,EAAE;AAAA,MAC7C;AAAA,IACF,CAAA;AAAA;AAGD,MAAI,cAAqB,CAAA;AAEzB,QAAM,YAAY,CAAO,SAAW;AAAA,WAAAI,cAAAA,UAAA,QAAA,QAAA,QAAA,aAAA;AAClC,UAAI,CAAC,QAAQ,CAAC,KAAK;AAAQ;AAC3B,UAAI,MAAM,SAAS,QAAQ;AAEzB,cAAM,mBAAkB;AACxB,YAAI,uBAAuB,sBAAsB;AAC/C,mBAAS,MAAM,KAAK,KAAK,MAAO,CAAA;AAAA,QACjC,OAAM;AACL,oBAAU,MAAM,KAAK,KAAK,MAAO,CAAA;AAAA,QAClC;AACDC,sBAAAA,WAAS,MAAA;AACP,qBAAW,MAAA;AACT,sBAAU,IAAI;AAAA,UACf,GAAE,GAAG;AAAA,QACR,CAAC;AAAA,MACF,WAAU,MAAM,SAAS,UAAU;AAElC,YAAI,YAAY;AAChB,cAAM,mBAAkB;AACxB,YAAI,SAAS,MAAM,SAAS,UAAU,MAAM,QAAQ;AAClD,sBAAY;AAAA,QACb;AACD,YAAI,YAAY;AAChB,YAAI,sBAAsB,sBAAsB;AAC9C,sBAAY;AAAA,QACb;AAGD,aAAK,QAAQ,CAAC,MAAM,UAAK;AACvB,cAAK,QAAQ,MAAM,KAAK,aAAc,WAAW;AAC/C,qBAAS,MAAM,KAAK,IAAI;AAAA,UACzB,OAAM;AACL,sBAAU,MAAM,KAAK,IAAI;AAAA,UAC1B;AACD,cAAI,CAAC,WAAW;AACd,wBAAY;AAAA,UACb;AACD,cAAI,aAAa,SAAS,GAAG;AAC3B,wBAAY;AAAA,UACb;AAAA,QACH,CAAC;AAAA,MACF;AAAA,IACF,CAAA;AAAA;AAGD,QAAM,iBAAiB,MAAA;AACrB,QAAI,CAAC,MAAM;AAAM;AACjB,aAAS,QAAQ;AACjB,cAAU,QAAQ;AAClB,0BAAsB;AACtB,2BAAuB;AACvBA,kBAAAA,WAAS,MAAA;AACP,oBAAc,MAAM;AACpB,gBAAU,MAAM,IAAI;AAAA,IACtB,CAAC;AAAA,EACH;AAEAC,gBAAK,MACH,MAAM;AAAA,WAAA,MAAM;AAAA,EAAN,GACN,CAAC,QAAG;AACF,QAAI,CAAC;AAAK;AACV,QAAI,YAAY,WAAW,IAAI;AAAQ;AACvC,UAAM,UAAUC,yCAAAA,UAAU,IAAI,MAAM,YAAY,MAAM,CAAC;AACvD,QAAI,CAAC,QAAQ,QAAQ;AACnB,eAAS,QAAQ;AACjB,gBAAU,QAAQ;AAClB,4BAAsB;AACtB,6BAAuB;AAAA,IACxB;AACDF,kBAAAA,WAAS,MAAA;AACP,oBAAc;AACd,gBAAU,OAAO;AAAA,IACnB,CAAC;AAAA,EACH,GACA;AAAA,IACE,WAAW;AAAA,EACZ,CAAA;AAGH,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA;AAEJ;;"}