{"version":3,"file":"use-lazy-load.js","sources":["uni_modules/tuniaoui-vue3/components/lazy-load/src/composables/use-lazy-load.ts"],"sourcesContent":["import {\n  computed,\n  getCurrentInstance,\n  nextTick,\n  onMounted,\n  onUnmounted,\n  ref,\n} from 'vue'\nimport { useObserver, useSelectorQuery } from '../../../../hooks'\nimport {\n  debugWarn,\n  generateId,\n  isEmptyVariableInDefault,\n} from '../../../../utils'\n\nimport type { LazyLoadProps } from '../lazy-load'\nimport type { LazyLoadStatus } from '../types'\n\nexport const useLazyLoad = (props: LazyLoadProps) => {\n  const instance = getCurrentInstance()\n  if (!instance) {\n    debugWarn('TnLazyLoad', '请在 setup 中使用 useLazyLoad')\n  }\n\n  const { emit } = instance!\n\n  const { getSelectorNodeInfo } = useSelectorQuery(instance)\n  const { connectObserver, disconnectObserver } = useObserver(instance)\n\n  const componentId = `tll-${generateId()}`\n\n  // 图片触发加载位置\n  const threshold = computed<number>(() =>\n    isEmptyVariableInDefault(props.threshold, 100)\n  )\n\n  // 图片加载状态\n  const imageStatus = ref<LazyLoadStatus>('waiting')\n  // 开始显示图片\n  const showImage = ref<boolean>(false)\n\n  let initCount = 0\n  // 初始化监听事件\n  const initObserver = async () => {\n    disconnectObserver()\n    try {\n      await getSelectorNodeInfo(`#${componentId}`)\n\n      initCount = 0\n\n      const bottomThreshold =\n        threshold.value < 0\n          ? -Math.abs(threshold.value)\n          : Math.abs(threshold.value)\n      connectObserver(\n        `#${componentId}`,\n        (res) => {\n          if (res.intersectionRatio > 0) {\n            // 开始显示图片\n            showImage.value = true\n            imageStatus.value = 'loading'\n            // 图片已加载关闭监听，减少资源消耗\n            disconnectObserver()\n          }\n        },\n        {\n          type: 'relativeToViewport',\n          margins: {\n            bottom: bottomThreshold,\n          },\n        }\n      )\n    } catch (err) {\n      if (initCount > 10) {\n        initCount = 0\n        debugWarn('TnLazyLoad', `获取图片节点信息失败：${err}`)\n        return\n      }\n      initCount++\n      setTimeout(() => {\n        initObserver()\n      }, 150)\n    }\n  }\n\n  // 图片加载完成事件\n  const handleImageLoadedSuccess = () => {\n    imageStatus.value = 'loaded'\n    emit('loaded')\n  }\n\n  // 图片加载失败事件\n  const handleImageLoadedFailed = (err: any) => {\n    debugWarn('TnLazyLoad', `图片加载失败: ${err}`)\n    imageStatus.value = 'error'\n    emit('error')\n  }\n\n  onMounted(() => {\n    nextTick(() => {\n      initObserver()\n    })\n  })\n\n  onUnmounted(() => {\n    disconnectObserver()\n  })\n\n  return {\n    componentId,\n    imageStatus,\n    showImage,\n    handleImageLoadedSuccess,\n    handleImageLoadedFailed,\n  }\n}\n"],"names":["getCurrentInstance","debugWarn","useSelectorQuery","useObserver","generateId","computed","isEmptyVariableInDefault","ref","__awaiter","onMounted","nextTick","onUnmounted"],"mappings":";;;;;;;;;AAkBO,MAAM,cAAc,CAAC,UAAoB;AAC9C,QAAM,WAAWA,cAAAA;AACjB,MAAI,CAAC,UAAU;AACbC,mDAAU,cAAc,0BAA0B;AAAA,EACnD;AAEO,QAAA,OAAS,SAAS;AAElB,QAAA,sBAAwBC,sDAAAA,iBAAiB,QAAQ;AACnD,QAAA,KAA0CC,6DAAY,QAAQ,GAA5D,kBAAe,GAAA,iBAAE,qBAAkB,GAAA;AAE3C,QAAM,cAAc,OAAOC,oCAAU,WAAA,CAAE;AAGvC,QAAM,YAAYC,cAAAA,SAAiB,MAAA;AACjC,WAAAC,gEAAyB,MAAM,WAAW,GAAG;AAAA,EAA7C,CAA8C;AAIhD,QAAM,cAAcC,kBAAoB,SAAS;AAEjD,QAAM,YAAYA,kBAAa,KAAK;AAEpC,MAAI,YAAY;AAEhB,QAAM,eAAe,MAAA;AAAA,WAAAC,cAAA,UAAA,QAAA,QAAA,QAAA,aAAA;AACnB;AACA,UAAI;AACF,cAAM,oBAAoB,IAAI,WAAW,EAAE;AAE3C,oBAAY;AAEZ,cAAM,kBACJ,UAAU,QAAQ,IACd,CAAC,KAAK,IAAI,UAAU,KAAK,IACzB,KAAK,IAAI,UAAU,KAAK;AAC9B,wBACE,IAAI,WAAW,IACf,CAAC,QAAG;AACF,cAAI,IAAI,oBAAoB,GAAG;AAE7B,sBAAU,QAAQ;AAClB,wBAAY,QAAQ;AAEpB;UACD;AAAA,QACH,GACA;AAAA,UACE,MAAM;AAAA,UACN,SAAS;AAAA,YACP,QAAQ;AAAA,UACT;AAAA,QACF,CAAA;AAAA,MAEJ,SAAQ,KAAK;AACZ,YAAI,YAAY,IAAI;AAClB,sBAAY;AACZP,+CAAAA,UAAU,cAAc,cAAc,GAAG,EAAE;AAC3C;AAAA,QACD;AACD;AACA,mBAAW,MAAA;AACT;QACD,GAAE,GAAG;AAAA,MACP;AAAA,IACF,CAAA;AAAA;AAGD,QAAM,2BAA2B,MAAA;AAC/B,gBAAY,QAAQ;AACpB,SAAK,QAAQ;AAAA,EACf;AAGA,QAAM,0BAA0B,CAAC,QAAQ;AACvCA,yCAAAA,UAAU,cAAc,WAAW,GAAG,EAAE;AACxC,gBAAY,QAAQ;AACpB,SAAK,OAAO;AAAA,EACd;AAEAQ,gBAAAA,UAAU,MAAA;AACRC,kBAAAA,WAAS,MAAA;AACP;IACF,CAAC;AAAA,EACH,CAAC;AAEDC,gBAAAA,YAAY,MAAA;AACV;EACF,CAAC;AAED,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA;AAEJ;;"}