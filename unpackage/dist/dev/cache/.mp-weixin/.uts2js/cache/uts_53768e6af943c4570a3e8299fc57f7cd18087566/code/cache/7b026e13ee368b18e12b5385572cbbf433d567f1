{"code":"import { __awaiter } from \"tslib\";\nimport { getCurrentInstance, nextTick, onMounted, ref, watch } from 'vue';\nimport { CHANGE_EVENT, UPDATE_MODEL_EVENT } from '../../../../constants';\nimport { useSelectorQuery, useTouch } from '../../../../hooks';\nimport { debugWarn, generateId } from '../../../../utils';\nimport { useFormItem } from '../../../form';\nimport useRateItemData from './use-rate-item-data';\nexport const useRate = (props, emits) => {\n    const instance = getCurrentInstance();\n    if (!instance) {\n        debugWarn('TnRate', '请在setup函数中使用useRate');\n    }\n    // 生成唯一id\n    const componentId = `tr-${generateId()}`;\n    const getSelectorNodeInfo = useSelectorQuery(instance).getSelectorNodeInfo;\n    const formItem = useFormItem().formItem;\n    const rateItemData = useRateItemData(props).rateItemData;\n    const _a = useTouch(), rateCurrentX = _a.currentX, updateRateTouchOptions = _a.updateOptions, rateTouchStartHandler = _a.onTouchStart, rateTouchMoveHandler = _a.onTouchMove, rateTouchEndHandler = _a.onTouchEnd;\n    // 更新选中的值\n    const updateValue = (value) => {\n        if (Number.isNaN(value)) {\n            debugWarn('TnRate', 'Rate回填数据发生错误');\n            value = 0;\n        }\n        emits(UPDATE_MODEL_EVENT, value);\n        nextTick(() => {\n            emits(CHANGE_EVENT, value);\n            if (props.validateEvent) {\n                formItem === null || formItem === void 0 ? void 0 : formItem.validate('change').catch((err) => {\n                    debugWarn('TnRate', `Rate验证发生错误: ${err}`);\n                });\n            }\n        });\n    };\n    // 容器的宽度\n    let componentItemWidth = 0;\n    const activeItemWidth = ref(0);\n    watch(() => { return props.modelValue; }, (val) => {\n        if (!props.allowHalf) {\n            val = Math.ceil(val);\n        }\n        activeItemWidth.value = val * componentItemWidth;\n    });\n    let initCount = 0;\n    // 获取组件和item的宽度信息\n    const getComponentRectInfo = () => { return __awaiter(void 0, void 0, void 0, function* () {\n        try {\n            const itemRectInfo = yield getSelectorNodeInfo(`#${componentId} .tn-rate__item`);\n            if (!(itemRectInfo === null || itemRectInfo === void 0 ? void 0 : itemRectInfo.width)) {\n                throw new Error('获取组件容器宽度失败');\n            }\n            componentItemWidth = itemRectInfo.width || 0;\n            const left = itemRectInfo.left || 0;\n            updateRateTouchOptions({\n                left,\n                right: componentItemWidth * props.max + left,\n                top: itemRectInfo.top,\n                bottom: itemRectInfo.bottom,\n            });\n            let initValue = props.modelValue || 0;\n            // 初始化完成后，选中值为min\n            if (props.modelValue && props.modelValue < props.min) {\n                initValue = props.min;\n            }\n            activeItemWidth.value = initValue * componentItemWidth;\n            updateValue(initValue);\n        }\n        catch (err) {\n            if (initCount > 10) {\n                initCount = 0;\n                debugWarn('TnRate', `获取组件容器信息失败: ${err}`);\n                return;\n            }\n            initCount++;\n            setTimeout(() => {\n                getComponentRectInfo();\n            }, 300);\n        }\n    }); };\n    // 组件滑动事件\n    const onTouchStart = (event) => {\n        rateTouchStartHandler(event);\n    };\n    const onTouchMove = (event) => {\n        rateTouchMoveHandler(event);\n        //\n        if (props.readonly)\n            return;\n        activeItemWidth.value = rateCurrentX.value;\n    };\n    const onTouchEnd = (event) => {\n        rateTouchEndHandler(event);\n        if (props.readonly)\n            return;\n        if (props.allowHalf) {\n            // 滑动结束后，判断当前滑动的距离是否为item的宽度的一半\n            const componentItemWidthHalf = componentItemWidth / 2;\n            let count = Math.ceil(rateCurrentX.value / componentItemWidthHalf);\n            if (count % 2 !== 0) {\n                if (rateCurrentX.value <\n                    componentItemWidthHalf * (count - 1) + componentItemWidthHalf / 2) {\n                    count -= 1;\n                }\n            }\n            else {\n                if (rateCurrentX.value <\n                    componentItemWidthHalf * (count - 1) + componentItemWidthHalf / 3) {\n                    count -= 1;\n                }\n            }\n            if (rateCurrentX.value <\n                componentItemWidthHalf * (count - 1) + componentItemWidthHalf / 2 &&\n                count % 2 !== 0) {\n                count -= 1;\n            }\n            // 判断是否小于最小值\n            if (count < props.min * 2) {\n                count = props.min * 2;\n            }\n            activeItemWidth.value = componentItemWidthHalf * count;\n            updateValue(count / 2);\n        }\n        else {\n            let count = Math.ceil(rateCurrentX.value / componentItemWidth);\n            if (count > 1 && rateCurrentX.value < componentItemWidth * (count - 1)) {\n                count -= 1;\n            }\n            // 判断是否小于最小值\n            if (count < props.min) {\n                count = props.min;\n            }\n            activeItemWidth.value = componentItemWidth * count;\n            updateValue(count);\n        }\n    };\n    onMounted(() => {\n        nextTick(() => {\n            getComponentRectInfo();\n        });\n    });\n    return {\n        componentId,\n        rateItemData,\n        activeItemWidth,\n        onTouchStart,\n        onTouchMove,\n        onTouchEnd,\n    };\n};\n//# sourceMappingURL=D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/rate/src/composables/use-rate.js.map","references":["D:/DEV/HBuilderX/plugins/uniapp-cli-vite/node_modules/@vue/runtime-core/dist/runtime-core.d.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/constants/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/hooks/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/utils/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/form/index.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/rate/src/composables/use-rate-item-data.ts","D:/DEV/HBuilderX/plugins/uniapp-cli-vite/node_modules/@vue/runtime-core/dist/runtime-core.d.ts","D:/DEV/Project/wallpaper-share-wx/uni_modules/tuniaoui-vue3/components/rate/src/rate.ts"],"uniExtApis":[],"map":"{\"version\":3,\"file\":\"use-rate.js\",\"sourceRoot\":\"\",\"sources\":[\"use-rate.ts\"],\"names\":[],\"mappings\":\"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\"}"}
